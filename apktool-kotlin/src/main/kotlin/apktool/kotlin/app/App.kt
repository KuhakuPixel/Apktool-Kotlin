/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package apktool.kotlin.app


import apktool.kotlin.lib.Apktool
import java.io.File

fun main(args: Array<String>) {


    Apktool(
            apkFile = args[0],
            decodeResource = false,
            cleanDecompilationFolder = false
    ).use {
        val decompiledFiles: Array<File> = it.decompilationFolder!!.toFile().listFiles()!!

        for (f: File in decompiledFiles) {
            println("${f.absolutePath}")
        }
        // ============== begin the patch process ================
        val apiFolderPath = File(it.decompilationFolder.toString(), "smali/com/android/billingclient/api/")
        val billingClientFiles: Array<File> = apiFolderPath.listFiles()

        // for folder, find the exact and replace
        for (f in billingClientFiles) {
            // write

            val text: String = f.readText()

            // replace the string
            val newPackageToOverwrite = "\"com.kuhakupixel.purchaseserver\""

            var newText = ""
            newText = text.replace("\"com.android.vending\"", newPackageToOverwrite)
            newText = newText.replace("\"com.android.vending.billing.InAppBillingService.BIND\"", newPackageToOverwrite)

            // if something change, then write to it
            if (text != newText) {
                println("writting to ${f.absolutePath}")
                f.printWriter().use { out ->
                    out.print(newText)
                }
            }
        }


        it.export("Recompiled.apk", signApk = true)
    }


}
